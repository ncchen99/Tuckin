
# TUCKIN APP 需求文件

## 1. 概述

### 1.1 APP 名稱
**TUCKIN**

### 1.2 目標用戶
專門為成大學生打造的免費交友與聚餐平台

### 1.3 核心理念
利用智能配對與聚餐活動，促進校內學生間的互動與交流，並藉由趣味化的流程與活動營造輕鬆友善的氛圍

### 1.4 前後端架構劃分
- **前端 (Flutter APP)**: 負責用戶介面展示、本地狀態管理、與後端API通信
- **後端 (Supabase Edge Functions)**: 負責數據存儲、配對算法、通知系統、身份驗證等服務

---

## 2. 整體架構與專案結構

### 2.1 技術架構
- **前端**: 基於 Flutter 開發的跨平台應用
- **後端**: 使用 Supabase 作為後端服務，包含數據庫和 Edge Functions
- **第三方整合**: Google Place API 提供餐廳信息

### 2.2 現有專案目錄結構
```
/lib
  /screens
    /onboarding           - 初次使用流程
      welcome_screen.dart       - 已完成
      login_page.dart           - 已完成
      profile_setup_page.dart   - 已完成
      food_preference_page.dart - 已完成
      personality_test_page.dart - 已完成
    /dinner              - 聚餐相關頁面
      dinner_reservation_page.dart  - 聚餐預約
      matching_status_page.dart     - 配對狀態
      attendance_confirmation_page.dart - 出席確認
      restaurant_selection_page.dart - 餐廳選擇
      dinner_info_page.dart         - 聚餐資訊
      rating_page.dart              - 評分頁面
    /profile             - 用戶相關頁面
      user_profile_page.dart    - 用戶資料
      settings_page.dart        - 設定頁面
    /utility
      notifications_page.dart   - 通知頁面
      faq_page.dart             - 常見問題
  /components
    /common              - 通用組件
    /dinner              - 聚餐相關組件
    /profile             - 用戶相關組件
  /services              - 已有服務層
  /utils                 - 已有工具層
  /models               - 新增數據模型層
  main.dart              - 應用入口
```

### 2.3 後端架構 (Supabase)
```
/edge-functions
  /auth            - 認證相關函數
  /matching        - 配對算法實現
  /notifications   - 通知系統
  /restaurants     - 餐廳資訊與推薦
  /ratings         - 評分處理
  /cron            - 定時任務處理
```

---

## 3. 使用者流程與功能需求 (前後端職責劃分)

### 3.1 登入與初次設定 (已完成)

- **前端職責**:
  - 登入界面與表單
  - 初次設定流程引導
  - 資料輸入界面
  - 個性測驗界面與互動

- **後端職責**:
  - 用戶認證與 Session 管理
  - 儲存用戶設定資料
  - 處理 Email 驗證
  - 成大 email 識別與標記

---

### 3.2 聚餐預約與配對 (待開發)

- **前端職責**:
  - 聚餐預約界面
  - 配對狀態顯示
  - 出席確認界面
  - 時間倒數計時器
  - 用戶預約數據的本地暫存

- **後端職責**:
  - **配對算法核心實現**:
    - 活動前2天午夜 12 點自動執行配對程序
    - 基於個性測驗、飲食喜好進行智能配對
    - 按 4 人小組(理想 2 男 2 女)進行分組
    - 配對優先順序邏輯處理
  - **出席確認處理**:
    - 儲存用戶出席確認狀態
    - 管理候補池與自動補位
    - 聚餐成團與取消邏輯
  - **通知推送**:
    - 配對結果通知
    - 出席確認提醒
    - 聚餐取消通知

---

### 3.3 餐廳選擇與確認流程 (待開發)

- **前端職責**:
  - 餐廳卡片展示界面
  - 餐廳類別選擇界面
  - 餐廳詳情顯示
  - 用戶選擇互動
  - 餐廳資訊的本地緩存

- **後端職責**:
  - **餐廳推薦算法**:
    - 計算聚餐成員喜愛餐廳種類交集
    - 處理餐廳種類出現頻率統計
    - 根據不同階段用戶提供適合的推薦邏輯
  - **餐廳最終決策**:
    - 統計所有成員的餐廳選票
    - 選出最終餐廳
    - 處理餐廳訂位邏輯
  - **Google Place API 整合**:
    - 提供餐廳資訊查詢
    - 確認餐廳營業狀態
  - **候選餐廳管理**:
    - 維護備選餐廳資料庫
    - 處理訂位失敗或未營業的餐廳替代邏輯

---

### 3.4 聚餐資訊顯示頁 (待開發)

- **前端職責**:
  - 餐廳與聚餐資訊顯示
  - 虛擬互動花園界面實現
  - 黏土風格角色顯示
  - 破冰問題界面
  - 互動小活動的用戶界面

- **後端職責**:
  - 儲存並提供聚餐最終確認資訊
  - 管理用戶互動數據
  - 隨機分配「小主人」任務
  - 提供破冰問題庫
  - 處理聚餐活動狀態更新
  - 管理用戶之間的互動數據

---

### 3.5 聚餐後評分與配對優先順序影響 (待開發)

- **前端職責**:
  - 評分界面實現
  - 參與者列表顯示
  - 評論輸入功能
  - 評分數據本地緩存

- **後端職責**:
  - **評分數據處理**:
    - 儲存用戶評分資料
    - 計算「令我感到不舒服」評分影響
  - **配對優先順序算法**:
    - 基於參與次數調整優先順序
    - 根據出席狀況計算扣分
    - 處理確認後取消的影響
    - 維護用戶信用評分系統
  - **配對優先順序影響實現**:
    - 如某用戶獲得2次以上「令我感到不舒服」評分，大幅降低其配對優先順序
    - 根據參與次數調整優先度（新用戶優先級較高）
    - 對確認後未出席者每次扣除較高匹配分數（如10分）
    - 對確認後取消參與者每次扣除較低匹配分數（如5分）

---

## 4. 需要開發的頁面與元件清單 (前端 APP)

### 4.1 核心功能頁面

#### ✅ 已完成頁面
- **新手介紹頁面** (welcome_screen.dart)
- **登入頁面** (login_page.dart)
- **基本資料填寫頁** (profile_setup_page.dart)
- **飲食偏好設定頁** (food_preference_page.dart)
- **個性測驗頁** (personality_test_page.dart)

#### 待開發頁面
1. **✅聚餐預約頁面** (dinner_reservation_page.dart)
   - 日期選擇按鈕（星期一或星期四）
   - 預約截止時間顯示
   - 成大限定勾選框
   - 確認預約按鈕

2. **✅配對狀態頁面** (matching_status_page.dart)
   - 匹配進行圖示
   - 匹配成功提示

3. **✅出席確認頁面** (attendance_confirmation_page.dart)
   - 聚餐資訊展示，時間
   - 出席確認按鈕
   - 倒數計時/截止提醒
   - 確認按鈕

4. **✅餐廳選擇頁面** (restaurant_selection_page.dart)
   - 推薦餐廳卡片
   - "我想推薦餐廳"按鈕
   - 餐廳類型選擇欄
   - 餐廳推薦清單

5. **✅聚餐資訊頁面** (dinner_info_page.dart)
   - 最終餐廳確認資訊
   - 聚餐時間地點

6. **評分頁面** (rating_page.dart)
   - 參與者列表
   - 評分選項
   - 評論欄
   - 提交評分按鈕

8. **用戶資料頁面** (user_profile_page.dart)
   - 頭像與基本資料
   - 編輯功能
   - 聚餐歷史記錄

9. **設定頁面** (settings_page.dart)
   - 通知設定
   - 隱私與條款
   - 其他選項

10. **幫助與常見問題頁面** (faq_page.dart)
    - 常見問題列表
    - 聯絡客服功能

### 4.2 共享組件建議

#### 現有組件（已完成）
- custom_checkbox.dart
- image_button.dart 
- icon_text_input.dart
- loading_image.dart
- back_button.dart
- google_sign_in_button.dart
- privacy_policy_dialog.dart
- progress_dots_indicator.dart
- stroke_text_widget.dart

#### 需開發的新組件

1. **共用頂部導航** (header_bar.dart)
   - 包含通知鈴鐺和用戶圖示
   - 頁面標題顯示

2. **餐廳推薦卡片** (restaurant_card.dart)
   - 顯示餐廳圖片、名稱、類型
   - 選擇按鈕

3. **用戶簡介卡片** (user_preview_card.dart)
   - 用於顯示參與者基本信息
   - 可用於配對狀態和聚餐資訊頁

4. **倒計時組件** (countdown_timer.dart)
   - 用於出席確認截止時間等多處

5. **黏土風格頭像** (clay_avatar.dart)
   - 用於虛擬花園互動

6. **評分選項卡** (rating_option_card.dart)
   - 用於聚餐後評分

7. **通知列表項** (notification_list_item.dart)
   - 用於顯示各類通知

### 4.3 數據模型

前端數據模型（對應後端實體）:

1. **User** - 用戶資料模型
2. **DiningEvent** - 聚餐事件模型
3. **Restaurant** - 餐廳資訊模型
4. **Rating** - 評分模型
5. **Notification** - 通知模型

---

## 5. 後端開發需求 (Supabase Edge Functions)

### 5.1 核心功能實現

1. **用戶認證與管理**
   - 處理註冊、登入流程
   - Email 驗證
   - 用戶身份檢查和權限控制

2. **聚餐配對系統**
   - 定時觸發的配對算法 (活動前2天午夜12點執行)
   - 優先順序計算邏輯
   - 性別平衡處理 (理想2男2女)
   - 配對結果分組與儲存

3. **餐廳推薦系統**
   - 基於用戶偏好的推薦算法
   - 實現不同階段用戶的推薦邏輯:
     - 第一位使用者: 計算交集，找出最多的種類
     - 第二位使用者: 沿用第一位+新推薦
     - 第三位使用者: 顯示前兩位選擇
     - 第四位使用者: 依邏輯產生推薦
   - Google Place API 整合
   - 最終餐廳選擇邏輯 (統計票數，處理平票情況)
   - 訂位與營業狀態確認邏輯

4. **通知系統**
   - 配對結果通知
   - 出席確認提醒
   - 餐廳確認通知
   - 系統公告發送

5. **定時任務處理**
   - 配對執行任務 (活動前2天午夜)
   - 出席確認截止處理 (活動前1天下午5點)
   - 聚餐成團確認 (活動當天晚上5點)

6. **數據分析與統計**
   - 用戶參與度統計
   - 餐廳受歡迎度分析
   - 配對成功率追蹤

### 5.2 數據庫結構 (Supabase Tables)

1. **users_profiles** - 用戶基本資料表
   + user_id
   + nickname
   + gender
   + personal_desc
   + personality_type
   + food_preference
   + created_at
   + updated_at
2. **user_status** - 用戶狀態表
   + user_id
   + status

2. users_profiles 的 view 
   + user_id
   + nickname
   + personal_desc

2. uuid 與 groupid mapping 表，允許用戶使用 groupid 反查 group 中其他人的 uuid
2. **dining_events** - 聚餐事件 (日期、時間、狀態、用戶)
4. **restaurants** - 餐廳資訊 (類型、地址、營業時間)
5. **restaurant_votes** - 餐廳投票記錄
6. **ratings** - 評分記錄 (包含不舒服評分)
7. **notifications** - 通知記錄
8. **matching_scores** - 配對分數記錄 (儲存優先順序相關分數)

群組管理模組
   + 呼叫餐廳管理模組產生推薦的餐廳列表並且存入 restaurant_votes 
餐廳管理模組
通知模組
用戶資料處理模組
通用工具

---

## 6. 開發優先級與建議

### 6.1 優先開發順序

1. **主循環核心功能**
   - 聚餐預約頁面 (前端) + 預約資料處理 (後端)
   - 配對狀態頁面 (前端) + 配對算法實現 (後端)
   - 出席確認頁面 (前端) + 出席狀態處理 (後端)
   - 餐廳選擇頁面 (前端) + 餐廳推薦邏輯 (後端)
   - 聚餐資訊頁面 (前端) + 資訊整合服務 (後端)
   - 評分系統 (前端界面 + 後端資料處理)

2. **輔助功能**
   - 通知系統 (前端頁面 + 後端推送服務)
   

3. **個人資料及設定**
   - 用戶資料頁面 (前端) + 資料管理 (後端)
   - 設定頁面 (前端) + 設定儲存 (後端)
   - 幫助與常見問題頁面 (前端) + 資料服務 (後端)

### 6.2 技術建議

1. **前端 (APP)**
   - 使用 Provider 或 Riverpod 進行狀態管理
   - 實現響應式設計，確保跨裝置兼容性
   - 使用模塊化架構便於維護和擴展
   - 實現路由系統管理頁面流程

2. **後端 (Supabase Edge Functions)**
   - 利用 Supabase 的 Realtime 功能實現即時通知
   - 開發可擴展的 RESTful API
   - 實現高效的配對和推薦算法
   - 設置適當的權限控制和資料驗證
   - 使用 Cron 功能實現定時任務

3. **前後端整合**
   - 建立清晰的 API 文檔
   - 使用統一的數據結構和命名規範
   - 實現穩健的錯誤處理機制
   - 開發環境與生產環境分離

---

## 7. 其他附加功能與未來擴展

- **用戶回饋收集** (前端界面 + 後端處理)
- **餐廳與餐廳類型推薦優化** (後端算法改進)
- **社交功能拓展** (前端界面 + 後端服務)
- **平台擴展** (前端多平台支援 + 後端架構擴展)
- **演算法持續優化** (後端數據分析與算法改進)
- **增強虛擬互動體驗** (前端 UI/UX 優化)

---

## 8. 安全性與隱私保護

- **前端安全措施**:
  - 避免明文存儲敏感資訊
  - 實現安全的本地存儲
  - 通過HTTPS進行API通信
  - 輸入驗證與防護

- **後端安全措施**:
  - 使用 Supabase 的 Row Level Security
  - 實現適當的訪問控制
  - 敏感資料加密存儲
  - 定期備份與恢復計劃
  - API請求限流與防濫用機制

- **隱私保護**:
  - 符合相關資料保護規範
  - 清晰的隱私政策說明
  - 用戶資料權限控制
  - 提供資料刪除選項
  - 資料最小化原則
