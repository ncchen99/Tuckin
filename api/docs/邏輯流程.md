
## 1. 預約用戶大配對

### 1.1. 預約流程與用戶狀態設定

- **預約操作：**  
  用戶在預約階段點擊「預約」後，系統會將其狀態標記為 `waiting_matching`（等待配對狀態）。這表示用戶已完成預約，但尚未進入正式桌位配對。

### 1.2. 大配對機制（週二 6:00 AM）
在週二 6:00 AM 時，系統會啟動一個大配對程序，對所有處於 `waiting_matching` 狀態的預約用戶進行配對，具體流程如下：

- **配對規則：**  
  - 根據預約用戶的順序或其他預定規則，系統嘗試將用戶按 4 人一桌進行初步分組。
  - 對於已達到 4 人的組別，系統立即將這些用戶的狀態更新為 `waiting_confirmation`（等待確認階段），並推送通知告知用戶該桌位已成立，等待用戶在後續階段進行確認。

- **特殊情況：**  
  由於預約用戶數量可能無法整除 4，部分組別的人數會少於 4 人。對於這些不滿 4 人的組別，系統將保持其狀態為 `waiting_matching` 或進入等待補位流程，等待來自參加階段的用戶進行補齊。

---

## 2. 參加階段與補位處理

### 2.1. 參加階段定義
- **時間區間更新：**  
  參加按鈕階段：**週二 6:00 AM 至週三 06:00 AM**

- 在這段期間，尚未被配對到團體中的用戶(處於 `booking` 狀態)可以點擊「參加」按鈕：
  - 若點擊時已有可加入且人數不足 4 人的預約桌位，則該用戶可以直接補入桌位；
  - 若無可用桌位，則用戶將進入等待名單，等待系統在截止前進行自成桌位或自動補位。

### 2.2. 補位邏輯
- **補位條件：**  
  當候補等待中的桌位（原先預約配對中未達4人的組別）存在空缺時，系統會從參加階段的用戶中進行補位：
  - 補位策略可依照 FIFO 原則（先到先得）；
  - 補位成功後，該桌位中所有用戶狀態更新為 `waiting_confirmation`，並發送通知要求在指定時間內完成確認。

- **自成桌位（另一特殊處理）：**  
  如果在參加階段結束時，有一組數量在3到4之間（滿足條件但未達到4人）的等待用戶，則系統可視情況自動組成一桌，並通知這組用戶在 **週三 13:00 PM** 前完成確認，否則自動標記為 `confirmation_timeout`（逾時未確認階段）。

- **狀態大檢查**
  如果在參加階段結束時，有尚未完整但人數為三人的組別，一樣更改三人的狀態為出席，並且邀請最後一位確認用戶幫忙定位(無法定位就算了，此時已經時間不夠)。

---

## 3. 最終確認與後續處理

### 3.1. 確認與通知
- **等待確認階段：**  
  在大配對以及補位完成後，所有滿足 4 人條件的桌位用戶會處於 `waiting_confirmation` 狀態。  
  系統會發送通知，要求用戶在指定截止時間內完成最終確認（例如週二晚間或週三指定時間前）。

- **逾時處理：**  
  如果有用戶在截止時間內未完成確認，系統將自動將這些用戶的狀態標記為 `confirmation_timeout`。此時，系統可以進一步嘗試從等待名單中補位或提示用戶重試。

### 3.2. 後續狀態轉換
- 確認成功後，狀態將更新為 `waiting_attendance`（等待出席階段），等待活動當晚使用者的參與。
- 在活動完成後，再進一步進入後續的如出席評分等階段（例如 `rating`）。
- 用戶回復不參加時，呼叫 API 運行補位邏輯。

---

## 4. 整體邏輯與流程完整圖示

1. **預約階段：**
   - 用戶(處於 `booking` 狀態)點擊「預約」 → 狀態更新為 `waiting_matching`
   - 週二 6:00 AM 前，所有預約用戶皆為 `waiting_matching`

2. **大配對機制（週二 6:00 AM）：**
   - 系統啟動大配對，將所有 `waiting_matching` 狀態的用戶按照 4 人一桌進行分組
   - 對於滿 4 人的組別：
     - 直接更新這些用戶狀態為 `waiting_confirmation`
     - 進入確認階段，通知這些用戶需在週三 6:00 AM 前確認
     - 未在截止前確認的自動標記為 `confirmation_timeout`，則將該用戶移出該桌，此時此桌剩餘用戶數量少於 4 人，使用參加階段的新成員進行補位
     - 如果用戶回復不出席，則將該用戶移出該桌，此時此桌剩餘用戶數量少於 4 人，使用參加階段的新成員進行補位

   - 對於人數不足 4 人的組別：
     - 維持狀態為 `waiting_matching`，等待後續補位

3. **參加階段（週二 6:00 AM 至週三 06:00 AM）：**
   - 用戶(處於 `booking` 狀態)點擊「參加」：
     - 若可以補入已不足 4 人的桌位，則補位成功並將該用戶更新狀態為 `waiting_confirmation`，並發送通知告知該用戶需在週三 13:00 PM 前確認(其他用戶此時已確認)
     - 若無合適桌位，則進入等待名單
   - 如參加階段結束時，等待名單中用戶數達到大於 3 人，啟動自成桌位流程：
     - 自動分配新的桌位，並通知該桌用戶需在週三 13:00 PM 前確認
     - 未在截止前確認的自動標記為 `confirmation_timeout`

4. **最終確認階段：**
   - 所有 `waiting_confirmation` 的用戶收到通知，並需在指定時間內進行確認
   - 完成確認的用戶狀態轉為 `waiting_attendance`
   - 未確認的用戶狀態更新為 `confirmation_timeout`，系統可嘗試進一步補位

5. **活動進行與後續流程：**
   - 到達活動當天，確認用戶進入出席流程（`waiting_attendance`）
   - 後續可能進入評分階段（`rating`）或記錄缺席等

---

## 5. 補充注意事項

- **同步與鎖機制：**  
  在大配對和補位操作時，必須設置分布式鎖或使用資料庫事務來避免多個請求同時操作導致出現 race condition，確保桌位人數嚴格不會超過 4 人。

- **通知機制：**  
  建議整合推播系統（如 APNs 或 Firebase Cloud Messaging）來實現狀態變更時的即時通知，確保用戶能夠及時收到確認或補位要求。

- **錯誤處理與定時任務：**  
  針對預約大配對、參加補位以及最終確認均應設置相應的定時任務，並記錄異常狀況以便後續重試或人工干預。

